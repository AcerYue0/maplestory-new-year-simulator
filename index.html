<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¹´çš„æ°£æ¯ - æ´»å‹•æ¨¡æ“¬</title>
    <style>
        :root {
            --primary-red: #d32f2f;
            --primary-gold: #ffca28;
            --dark-red: #b71c1c;
            --bg-color: #fff8e1;
            --text-color: #333;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }

        header {
            background-color: var(--primary-red);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid var(--primary-gold);
        }

        h1 { margin: 0; font-size: 2em; }
        .subtitle { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        .timer { font-weight: bold; font-size: 1.2em; margin-top: 10px; color: var(--primary-gold); }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 15px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .section-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eee;
        }

        .section-title {
            border-left: 5px solid var(--primary-red);
            padding-left: 10px;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Gacha Section */
        .gacha-controls {
            text-align: center;
            padding: 20px;
            background: #ffebee;
            border-radius: 8px;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 1em;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }

        .btn-primary { background-color: var(--primary-red); color: white; font-weight: bold; }
        .btn-secondary { background-color: #555; color: white; }
        .btn-gold { background-color: var(--primary-gold); color: #333; font-weight: bold; }
        .btn-outline { background: transparent; border: 1px solid var(--primary-red); color: var(--primary-red); }

        /* Inventory Grid */
        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .zodiac-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            position: relative;
            background: white;
        }

        .zodiac-item.owned {
            border-color: var(--primary-gold);
            background-color: #fffde7;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .zodiac-icon { font-size: 2em; display: block; margin-bottom: 5px; }
        .zodiac-name { font-size: 0.8em; font-weight: bold; display: block; }
        .zodiac-count { 
            font-size: 0.9em; 
            color: var(--primary-red); 
            font-weight: bold; 
        }
        .zodiac-rate { display: none; }

        /* Essence Section */
        .exchange-panel {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            display: none; /* Hidden by default */
        }
        .exchange-panel.active { display: block; }

        .exchange-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .exchange-item {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
        }
        .exchange-item.owned { font-weight: bold; }
        .exchange-item:hover { background: #eee; }

        /* Wish Box Section */
        .box-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .wish-box {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .wish-box.available {
            border-color: var(--primary-red);
            background-color: #fff5f5;
        }

        .box-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .box-req { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .box-rewards { font-size: 0.8em; color: #555; text-align: left; margin-bottom: 10px; }

        /* Logs */
        .log-area {
            background: #333;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            border-radius: 5px;
            font-size: 0.9em;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal h2 { color: var(--primary-red); }
        .reward-highlight { font-size: 1.5em; color: var(--primary-gold); font-weight: bold; margin: 20px 0; }

        /* Responsive */
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .zodiac-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .material-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee; }
        .material-row input { width: 60px; padding: 5px; }
        
        .settings-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.9em; padding: 2px 0; }
        .settings-row input { width: 50px; padding: 2px; text-align: center; }
        
        /* Reward Grid */
        .reward-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .reward-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background: white;
        }
        .reward-img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; }
        .reward-name { font-size: 0.8em; font-weight: bold; display: block; }
        .reward-count { font-size: 0.9em; color: var(--primary-red); font-weight: bold; }

        /* Selection Modal Items */
        .selection-item {
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .selection-item.selected {
            box-shadow: 0 0 0 3px var(--primary-red);
            transform: scale(0.95);
        }
    </style>
</head>
<body>

<header>
    <h1>æ–°å¹´çš„æ°£æ¯</h1>
    <div class="subtitle">æ´»å‹•æœŸé–“ï¼š2026/01/01 00:00 ï½ 2026/01/13 23:59</div>
    <div class="timer" id="countdown">è¼‰å…¥ä¸­...</div>
    <button class="btn-secondary" style="margin-top: 10px; font-size: 0.8em;" onclick="resetData()">é‡ç½®æ‰€æœ‰æ•¸æ“š</button>
</header>

<div class="container main-layout">

    <!-- Left Panel -->
    <div class="left-panel">
        <!-- Gacha System -->
        <div class="section-card">
            <div class="section-title">
                <span>1. ç²å–æ°£æ¯</span>
            </div>
            <div class="gacha-controls">
                <p>ç›®å‰ç´¯è¨ˆæŠ½å–æ¬¡æ•¸: <span id="totalDraws" style="font-weight:bold; color:var(--primary-red);">0</span> <span style="color:#666; font-size:0.9em;">(ç´¯ç©èŠ±è²»: <span id="totalCost">0</span>)</span></p>
                <button class="btn-primary" onclick="drawGacha(1)">ä½¿ç”¨ 1 å€‹æ°£æ¯ (30)</button>
                <button class="btn-primary" onclick="drawGacha(10)">ä½¿ç”¨ 10 å€‹æ°£æ¯ (270)</button>
                <button class="btn-gold" id="autoDrawBtn" onclick="toggleAutoDraw()">ä¸€éµä¸Šé ­</button>
            </div>
        </div>

        <!-- Logs -->
        <div class="section-card">
            <div class="section-title">æ´»å‹•ç´€éŒ„</div>
            <div class="log-area" id="logArea"></div>
        </div>
    </div>

    <!-- Right Panel -->
    <div class="right-panel">
        <!-- Inventory & Exchange -->
        <div class="section-card">
            <div class="section-title">
                <span>2. ç”Ÿè‚–æ°£æ¯èƒŒåŒ…</span>
                <div id="inventoryControls">
                    <span style="margin-right: 10px; color: var(--dark-red); font-weight: bold;">ç²¾è¯: <span id="essenceCount">0</span></span>
                    <button class="btn-outline" style="font-size: 0.8em;" onclick="openDecomposeModal()">åˆ†è§£</button>
                    <button class="btn-outline" style="font-size: 0.8em;" onclick="toggleExchange()">å…Œæ›</button>
                </div>
                <div id="selectionControls" style="display:none; align-items: center;">
                    <span id="selectionStatus" style="font-size: 0.9em; margin-right: 10px; font-weight: bold; color: var(--primary-red);"></span>
                    <button class="btn-secondary" style="font-size: 0.8em; margin-right: 5px;" onclick="cancelSelectionMode()">å–æ¶ˆ</button>
                    <button class="btn-primary" style="font-size: 0.8em;" id="confirmInventorySelectionBtn" onclick="confirmInventorySelection()" disabled>ç¢ºèª</button>
                </div>
            </div>

            <div class="zodiac-grid" id="zodiacGrid">
                <!-- Grid items generated by JS -->
            </div>

            <!-- Exchange Panel (Hidden by default) -->
            <div class="exchange-panel" id="exchangePanel">
                <h3>æŒ‡å®šå…Œæ›</h3>
                <p>é¸æ“‡ç›®æ¨™æ°£æ¯ï¼Œä¸¦æ¶ˆè€—ç²¾è¯é€²è¡Œå…Œæ›ã€‚</p>
                <div class="exchange-grid" id="exchangeGrid">
                    <!-- Exchange items generated by JS -->
                </div>
            </div>
        </div>

        <!-- Wish Box System -->
        <div class="section-card">
            <div class="section-title">3. å¿ƒé¡˜ç®±å…Œæ›</div>
            <p style="font-size:0.9em; color:#666;">æ¶ˆè€—ä¸åŒç¨®é¡æ•¸é‡çš„æ°£æ¯ä¾†é–‹å•Ÿå¿ƒé¡˜ç®±ã€‚é–‹å•Ÿå¾Œæœƒæ‰£é™¤å°æ‡‰æ•¸é‡çš„æ°£æ¯ç¨®é¡ï¼ˆæ¯ç¨®æ‰£é™¤1å€‹ï¼‰ã€‚</p>
            <div class="box-container" id="boxContainer">
                <!-- Boxes generated by JS -->
            </div>
        </div>

        <!-- Reward History -->
        <div class="section-card">
            <div class="section-title">å¿ƒé¡˜ç®±å…Œæ›ç´€éŒ„</div>
            <div id="rewardLogGrid"></div>
        </div>
    </div>

</div>

<!-- Reward Modal -->
<div class="modal-overlay" id="rewardModal" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 id="modalTitle">æ­å–œç²å¾—</h2>
        <div class="reward-highlight" id="modalReward">çå‹µåç¨±</div>
        <button class="btn-primary" onclick="closeModal()">ç¢ºå®š</button>
    </div>
</div>

<!-- Exchange Selection Modal -->
<div class="modal-overlay" id="exchangeModal">
    <div class="modal" style="max-width: 400px;" onclick="event.stopPropagation()">
        <h2 id="exchangeTargetName">å…Œæ›ç›®æ¨™</h2>
        <p>ç¢ºå®šè¦æ¶ˆè€— <span id="exchangeCostDisplay" style="font-weight:bold; color:var(--dark-red);"></span> ç²¾è¯ä¾†å…Œæ›å—ï¼Ÿ</p>
        <p>ç›®å‰æŒæœ‰ç²¾è¯: <span id="currentEssenceDisplay" style="font-weight:bold;"></span></p>
        <div style="margin-top: 20px;">
            <button class="btn-secondary" onclick="closeExchangeModal()">å–æ¶ˆ</button>
            <button class="btn-primary" id="confirmExchangeBtn" onclick="confirmExchange()">ç¢ºèªå…Œæ›</button>
        </div>
    </div>
</div>

<!-- Decompose Modal -->
<div class="modal-overlay" id="decomposeModal">
    <div class="modal" style="max-width: 500px;" onclick="event.stopPropagation()">
        <h2>åˆ†è§£æ°£æ¯</h2>
        <p>é¸æ“‡è¦åˆ†è§£çš„æ°£æ¯è½‰åŒ–ç‚ºç²¾è¯</p>
        <div id="decomposeMaterials" style="text-align:left; max-height: 300px; overflow-y: auto; margin: 10px 0; border: 1px solid #eee; padding: 10px;"></div>
        <div style="margin-top: 10px; font-weight: bold; color: var(--dark-red);">
            é è¨ˆç²å¾—ç²¾è¯: <span id="decomposeEssencePreview">0</span>
        </div>
        <div style="margin-top: 20px;">
            <button class="btn-secondary" onclick="closeDecomposeModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="confirmDecompose()">ç¢ºèªåˆ†è§£</button>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const ZODIACS = [
        { id: 'horse', name: 'é¦¬', icon: 'ğŸ´', rate: 0.15, decomposeRate: 1, exchangeCost: 1500, color: '#ffb74d', darkColor: '#ef6c00' },
        { id: 'goat', name: 'ç¾Š', icon: 'ğŸ‘', rate: 0.20, decomposeRate: 1, exchangeCost: 1500, color: '#ffb74d', darkColor: '#ef6c00' },
        { id: 'monkey', name: 'çŒ´', icon: 'ğŸµ', rate: 0.25, decomposeRate: 1, exchangeCost: 1500, color: '#ffb74d', darkColor: '#ef6c00' },
        { id: 'rooster', name: 'é›', icon: 'ğŸ”', rate: 0.80, decomposeRate: 1, exchangeCost: 200, color: '#ba68c8', darkColor: '#6a1b9a' },
        { id: 'dog', name: 'ç‹—', icon: 'ğŸ¶', rate: 0.90, decomposeRate: 1, exchangeCost: 200, color: '#ba68c8', darkColor: '#6a1b9a' },
        { id: 'pig', name: 'è±¬', icon: 'ğŸ·', rate: 1.00, decomposeRate: 1, exchangeCost: 200, color: '#ba68c8', darkColor: '#6a1b9a' },
        { id: 'rat', name: 'é¼ ', icon: 'ğŸ­', rate: 2.50, decomposeRate: 1, exchangeCost: 50, color: '#64b5f6', darkColor: '#1565c0' },
        { id: 'ox', name: 'ç‰›', icon: 'ğŸ®', rate: 3.00, decomposeRate: 1, exchangeCost: 50, color: '#64b5f6', darkColor: '#1565c0' },
        { id: 'tiger', name: 'è™', icon: 'ğŸ¯', rate: 3.50, decomposeRate: 1, exchangeCost: 50, color: '#64b5f6', darkColor: '#1565c0' },
        { id: 'rabbit', name: 'å…”', icon: 'ğŸ°', rate: 29.20, decomposeRate: 1, exchangeCost: 10, color: '#81d4fa', darkColor: '#0277bd' },
        { id: 'dragon', name: 'é¾', icon: 'ğŸ²', rate: 29.25, decomposeRate: 1, exchangeCost: 10, color: '#81d4fa', darkColor: '#0277bd' },
        { id: 'snake', name: 'è›‡', icon: 'ğŸ', rate: 29.25, decomposeRate: 1, exchangeCost: 10, color: '#81d4fa', darkColor: '#0277bd' }
    ];

    const BOXES = [
        {
            id: 'small', name: 'å°å‰ç­‰ç´šç®±å­', req: 3, color: '#81c784',
            rewards: [
                { name: 'æ¢å¾©æ–¹å¡Š', img: './src/æ¢å¾©æ–¹å¡Š.png' },
                { name: 'é–ƒç‚«æ–¹å¡Š', img: './src/é–ƒç‚«æ–¹å¡Š.png' },
                { name: 'æ¢å¾©é™„åŠ æ–¹å¡Š', img: './src/æ¢å¾©é™„åŠ æ–¹å¡Š.png' }
            ]
        },
        {
            id: 'medium', name: 'ä¸­å‰ç­‰ç´šç®±å­', req: 6, color: '#64b5f6',
            rewards: [
                { name: 'é«˜ç´šè‡ªå®šç¾©çš®è†šè®Šæ›´åˆ¸', img: './src/é«˜ç´šè‡ªå®šç¾©çš®è†šè®Šæ›´åˆ¸.png' },
                { name: 'è‡ªç”±é€ å‹åˆ¸ 10å€‹', img: './src/è‡ªç”±é€ å‹åˆ¸.png' },
                { name: 'é«˜ç´šå½©è‰²ç¨œé¡ Pro', img: './src/é«˜ç´šå½©è‰²ç¨œé¡.png' }
            ]
        },
        {
            id: 'large', name: 'å¤§å‰ç­‰ç´šç®±å­', req: 9, color: '#ba68c8',
            rewards: [
                { name: 'é­”æ³•è³¦äºˆç¬¬3éšæ®µè³¦äºˆå·è»¸(ç½•è¦‹)', img: './src/é­”æ³•è³¦äºˆç¬¬3éšæ®µè³¦äºˆå·è»¸(ç½•è¦‹).png' },
                { name: 'æ™‚è£å…§è¥¯1ç¨®é¸æ“‡åˆ¸', img: './src/æ™‚è£å…§è¥¯1ç¨®é¸æ“‡åˆ¸.png' },
                { name: 'é­”æ³•éˆæ°£30å€‹', img: './src/é­”æ³•éˆæ°£.png' }
            ]
        },
        {
            id: 'transcend', name: 'è¶…è¶Šç­‰ç´šç®±å­', req: 12, color: '#ffd54f',
            rewards: [
                { name: 'è‹¦è¡Œçš„æˆ’æŒ‡', img: './src/è‹¦è¡Œçš„æˆ’æŒ‡.png' },
                { name: 'ç‡ƒç‡’ä¹‹æˆ’', img: './src/ç‡ƒç‡’ä¹‹æˆ’.png' },
                { name: 'è¼ªè¿´ç¢‘çŸ³', img: './src/è¼ªè¿´ç¢‘çŸ³.png' }
            ]
        }
    ];

    // --- State ---
    let inventory = {};
    let totalDraws = 0;
    let totalCost = 0;
    let essence = 0;
    let exchangeTargetId = null;
    let rewardCounts = {};
    let currentBoxId = null;
    let selectedMaterials = new Set();
    let isSelectionMode = false;
    let autoDrawInterval = null;

    // --- Initialization ---
    function init() {
        updateTimer();
        setInterval(updateTimer, 1000);
        renderInventory();
        renderBoxes();
        renderExchange();
        
        // Init Reward Counts
        BOXES.forEach(b => b.rewards.forEach(item => {
            if(rewardCounts[item.name] === undefined) rewardCounts[item.name] = 0;
        }));
        renderRewardLog();

        // Initialize inventory if empty
        if(Object.keys(inventory).length === 0) {
            resetData();
        }
        log("æ´»å‹•æ¨¡æ“¬å™¨å·²å•Ÿå‹•ã€‚");
    }

    function resetData() {
        if (autoDrawInterval) toggleAutoDraw();
        inventory = {};
        ZODIACS.forEach(z => {
            inventory[z.id] = 0;
        });
        essence = 0;
        for(let key in rewardCounts) rewardCounts[key] = 0;
        
        totalDraws = 0;
        document.getElementById('totalDraws').innerText = 0;
        totalCost = 0;
        document.getElementById('totalCost').innerText = 0;
        document.getElementById('logArea').innerHTML = '';
        log("æ•¸æ“šå·²é‡ç½®ã€‚");
        renderInventory();
        renderBoxes();
        renderRewardLog();
    }

    // --- Logic: Timer ---
    function updateTimer() {
        const end = new Date('2026-01-13T23:59:00').getTime();
        const now = new Date().getTime(); // Using current real time for simulation feel, or fixed if strictly needed
        // For simulation purposes, if we are before 2026, it shows countdown. 
        // If we are past, it shows ended. 
        // Since current date is 2025 (in context), it will show a long countdown.
        
        const distance = end - now;
        
        if (distance < 0) {
            document.getElementById('countdown').innerText = "æ´»å‹•å·²çµæŸ";
            return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        document.getElementById('countdown').innerText = `å‰©é¤˜æ™‚é–“ï¼š${days}å¤© ${hours}æ™‚ ${minutes}åˆ† ${seconds}ç§’`;
    }

    // --- Logic: Gacha ---
    function drawGacha(times) {
        const cost = (times === 10) ? 270 : (times * 30);
        totalCost += cost;
        document.getElementById('totalCost').innerText = totalCost;

        let results = [];
        for(let i=0; i<times; i++) {
            const rand = Math.random() * 100;
            let cumulative = 0;
            for(let z of ZODIACS) {
                cumulative += z.rate;
                if(rand <= cumulative) {
                    inventory[z.id]++;
                    results.push(z.name);
                    break;
                }
            }
        }
        totalDraws += times;
        document.getElementById('totalDraws').innerText = totalDraws;
        
        // Log results
        if(times === 1) {
            log(`ç²å¾—æ°£æ¯: ${results[0]}`);
        } else {
            // Group counts for cleaner log
            const counts = {};
            results.forEach(x => counts[x] = (counts[x] || 0) + 1);
            const logStr = Object.entries(counts).map(([k,v]) => `${k}x${v}`).join(', ');
            log(`10é€£æŠ½çµæœ: ${logStr}`);
        }

        renderInventory();
        renderBoxes(); // Update box availability
    }

    function toggleAutoDraw() {
        if (autoDrawInterval) {
            clearInterval(autoDrawInterval);
            autoDrawInterval = null;
            document.getElementById('autoDrawBtn').innerText = "ä¸€éµä¸Šé ­";
            log("å·²åœæ­¢è‡ªå‹•æŠ½å–ã€‚");
        } else {
            if (ZODIACS.every(z => inventory[z.id] > 0)) {
                alert("æ‚¨å·²ç¶“é›†é½Šæ‰€æœ‰æ°£æ¯äº†ï¼");
                return;
            }
            document.getElementById('autoDrawBtn').innerText = "åœæ­¢æŠ½å–";
            log("é–‹å§‹ä¸€éµä¸Šé ­æ¨¡å¼ï¼");
            autoDrawInterval = setInterval(() => {
                drawGacha(10);
                if (ZODIACS.every(z => inventory[z.id] > 0)) {
                    toggleAutoDraw();
                    log("æ­å–œï¼å·²é›†é½Šæ‰€æœ‰ 12 ç¨®æ°£æ¯ï¼Œè‡ªå‹•åœæ­¢ã€‚");
                    alert("æ­å–œï¼å·²é›†é½Šæ‰€æœ‰ 12 ç¨®æ°£æ¯ï¼");
                }
            }, 100);
        }
    }

    // --- Logic: Inventory & Essence ---
    function renderInventory() {
        const grid = document.getElementById('zodiacGrid');
        grid.innerHTML = '';
        
        ZODIACS.forEach(z => {
            const count = inventory[z.id];
            const div = document.createElement('div');
            div.className = `zodiac-item ${count > 0 ? 'owned' : ''}`;

            if (isSelectionMode && count > 0) {
                div.classList.add('selection-item');
                div.style.cursor = 'pointer';
                if (selectedMaterials.has(z.id)) {
                    div.classList.add('selected');
                }
                div.onclick = () => toggleInventorySelection(z.id);
            } else {
                div.onclick = null;
            }
            
            if(count > 0) {
                div.style.backgroundColor = z.color;
                div.style.color = '#333';
            } else {
                div.style.backgroundColor = z.darkColor;
                div.style.color = '#fff';
            }

            div.innerHTML = `
                <span class="zodiac-icon">${z.icon}</span>
                <span class="zodiac-name">${z.name}</span>
                <span class="zodiac-count">${count}</span>
                <span class="zodiac-rate">${z.rate}%</span>
            `;
            grid.appendChild(div);
        });
        document.getElementById('essenceCount').innerText = essence;
    }

    function toggleExchange() {
        const panel = document.getElementById('exchangePanel');
        panel.classList.toggle('active');
    }

    function renderExchange() {
        const grid = document.getElementById('exchangeGrid');
        grid.innerHTML = '';
        ZODIACS.forEach(z => {
            const count = inventory[z.id];
            const div = document.createElement('div');
            div.className = `exchange-item ${count > 0 ? 'owned' : ''}`;
            
            if(count > 0) {
                div.style.backgroundColor = z.color;
                div.style.color = '#333';
            } else {
                div.style.backgroundColor = z.darkColor;
                div.style.color = '#fff';
            }
            
            div.innerHTML = `
                <div>${z.icon} ${z.name}</div>
                <div style="font-size:0.8em; opacity:0.8;">ç²¾è¯: ${z.exchangeCost}</div>
            `;
            div.onclick = () => openExchangeModal(z.id);
            grid.appendChild(div);
        });
    }

    // --- Exchange Modal Logic ---
    function openExchangeModal(targetId) {
        exchangeTargetId = targetId;
        const targetZodiac = ZODIACS.find(z => z.id === targetId);
        const targetName = targetZodiac.name;
        const cost = targetZodiac.exchangeCost;
        
        document.getElementById('exchangeTargetName').innerText = `å…Œæ›ç›®æ¨™ï¼š${targetName}`;
        document.getElementById('exchangeCostDisplay').innerText = cost;
        document.getElementById('currentEssenceDisplay').innerText = essence;
        
        const btn = document.getElementById('confirmExchangeBtn');
        if (essence >= cost) {
            btn.disabled = false;
            btn.innerText = "ç¢ºèªå…Œæ›";
        } else {
            btn.disabled = true;
            btn.innerText = "ç²¾è¯ä¸è¶³";
        }

        document.getElementById('exchangeModal').style.display = 'flex';
    }

    function closeExchangeModal() {
        document.getElementById('exchangeModal').style.display = 'none';
        exchangeTargetId = null;
    }

    function confirmExchange() {
        const targetZodiac = ZODIACS.find(z => z.id === exchangeTargetId);
        const cost = targetZodiac ? targetZodiac.exchangeCost : 100;

        if(essence < cost) return;

        // Execute exchange
        essence -= cost;
        inventory[exchangeTargetId]++;
        
        log(`æ¶ˆè€— ${cost} ç²¾è¯ï¼Œå…Œæ›äº† [${getZodiacName(exchangeTargetId)}]`);
        closeExchangeModal();
        renderInventory();
        renderBoxes();
    }

    // --- Decompose Logic ---
    function openDecomposeModal() {
        document.getElementById('decomposeModal').style.display = 'flex';
        renderDecomposeMaterials();
    }

    function closeDecomposeModal() {
        document.getElementById('decomposeModal').style.display = 'none';
    }

    function renderDecomposeMaterials() {
        const container = document.getElementById('decomposeMaterials');
        container.innerHTML = '';
        
        ZODIACS.forEach(z => {
            if(inventory[z.id] > 0) {
                const row = document.createElement('div');
                row.className = 'material-row';
                row.innerHTML = `
                    <span>${z.icon} ${z.name} (æŒæœ‰: ${inventory[z.id]}) [1:${z.decomposeRate}]</span>
                    <input type="number" min="0" max="${inventory[z.id]}" value="0" 
                           class="decompose-input" data-id="${z.id}" oninput="updateDecomposeSummary()">
                `;
                container.appendChild(row);
            }
        });
        updateDecomposeSummary();
    }

    function updateDecomposeSummary() {
        const inputs = document.querySelectorAll('.decompose-input');
        let totalEssence = 0;
        inputs.forEach(input => {
            let val = parseInt(input.value) || 0;
            if(val < 0) val = 0;
            const max = parseInt(input.max);
            if(val > max) { val = max; input.value = max; }
            
            const id = input.dataset.id;
            const z = ZODIACS.find(item => item.id === id);
            totalEssence += val * (z.decomposeRate || 1);
        });
        document.getElementById('decomposeEssencePreview').innerText = totalEssence;
    }

    function confirmDecompose() {
        const inputs = document.querySelectorAll('.decompose-input');
        let totalEssence = 0;
        let logDetails = [];

        inputs.forEach(input => {
            const val = parseInt(input.value) || 0;
            if(val > 0) {
                const id = input.dataset.id;
                inventory[id] -= val;
                const z = ZODIACS.find(item => item.id === id);
                const gained = val * (z.decomposeRate || 1);
                totalEssence += gained;
                logDetails.push(`${getZodiacName(id)}x${val}`);
            }
        });

        if(totalEssence === 0) return;

        essence += totalEssence;
        log(`åˆ†è§£: ${logDetails.join(', ')}ï¼Œç²å¾— ${totalEssence} ç²¾è¯`);
        
        closeDecomposeModal();
        renderInventory();
        renderBoxes();
    }

    // --- Logic: Boxes ---
    function renderBoxes() {
        const container = document.getElementById('boxContainer');
        container.innerHTML = '';

        // Calculate owned unique types
        const ownedTypes = ZODIACS.filter(z => inventory[z.id] > 0).map(z => z.id);
        const uniqueCount = ownedTypes.length;

        BOXES.forEach(box => {
            const canOpen = uniqueCount >= box.req;
            const div = document.createElement('div');
            div.className = `wish-box ${canOpen ? 'available' : ''}`;
            div.innerHTML = `
                <div class="box-title" style="color:${box.color}">${box.name}</div>
                <div class="box-req">éœ€æ¶ˆè€— ${box.req} ç¨®æ°£æ¯ (ç›®å‰: ${uniqueCount})</div>
                <div class="box-rewards">
                    <strong>å¯èƒ½çå‹µ:</strong><br>
                    ${box.rewards.map(r => `â€¢ ${r.name}`).join('<br>')}
                </div>
                <button class="${canOpen ? 'btn-primary' : 'btn-secondary'}" 
                    ${canOpen ? '' : 'disabled'} 
                    onclick="openBox('${box.id}')">
                    ${canOpen ? 'é–‹å•Ÿç®±å­' : 'æ¢ä»¶æœªç¬¦'}
                </button>
            `;
            container.appendChild(div);
        });
    }

    function openBox(boxId) {
        const box = BOXES.find(b => b.id === boxId);
        if(!box) return;

        // Get owned types
        const ownedTypes = ZODIACS.filter(z => inventory[z.id] > 0).map(z => z.id);
        
        if(ownedTypes.length < box.req) {
            alert("æŒæœ‰çš„æ°£æ¯ç¨®é¡ä¸è¶³ï¼");
            return;
        }

        currentBoxId = boxId;
        selectedMaterials.clear();

        // å¦‚æœéœ€æ±‚æ˜¯ 12 ç¨® (è¶…è¶Šç­‰ç´šç®±å­)ï¼Œç›´æ¥å…¨é¸ä¸¦é–‹å•Ÿï¼Œè·³éé¸æ“‡ä»‹é¢
        if (box.req === 12) {
            ZODIACS.forEach(z => selectedMaterials.add(z.id));
            confirmInventorySelection();
            return;
        }

        startSelectionMode();
    }

    function startSelectionMode() {
        isSelectionMode = true;
        document.getElementById('inventoryControls').style.display = 'none';
        document.getElementById('selectionControls').style.display = 'flex';
        updateSelectionUI();
        renderInventory();
        // è‡ªå‹•æ²å‹•åˆ°èƒŒåŒ…ä½ç½®
        document.getElementById('zodiacGrid').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function cancelSelectionMode() {
        isSelectionMode = false;
        currentBoxId = null;
        selectedMaterials.clear();
        document.getElementById('inventoryControls').style.display = 'block';
        document.getElementById('selectionControls').style.display = 'none';
        renderInventory();
    }

    function toggleInventorySelection(id) {
        const box = BOXES.find(b => b.id === currentBoxId);
        if (selectedMaterials.has(id)) {
            selectedMaterials.delete(id);
        } else {
            if (selectedMaterials.size < box.req) {
                selectedMaterials.add(id);
            }
        }
        renderInventory();
        updateSelectionUI();
    }

    function updateSelectionUI() {
        const box = BOXES.find(b => b.id === currentBoxId);
        if(!box) return;
        
        const btn = document.getElementById('confirmInventorySelectionBtn');
        const status = document.getElementById('selectionStatus');
        const current = selectedMaterials.size;
        
        status.innerText = `è«‹é¸æ“‡ ${box.req} ç¨®æ°£æ¯ (${current}/${box.req})`;
        btn.innerText = `ç¢ºèªé–‹å•Ÿ`;
        btn.disabled = (current !== box.req);
    }

    function confirmInventorySelection() {
        const box = BOXES.find(b => b.id === currentBoxId);
        if (selectedMaterials.size !== box.req) return;

        // Consume
        const typesToConsume = Array.from(selectedMaterials);
        typesToConsume.forEach(id => inventory[id]--);

        // Reward
        const rewardIndex = Math.floor(Math.random() * box.rewards.length);
        const reward = box.rewards[rewardIndex];

        log(`é–‹å•Ÿ [${box.name}]ï¼Œæ¶ˆè€—æ°£æ¯: [${typesToConsume.map(getZodiacName).join(', ')}]`);
        log(`>>> ç²å¾—å¤§ç: ${reward.name}`);

        // Record reward
        if(rewardCounts[reward.name] !== undefined) {
            rewardCounts[reward.name]++;
        }
        renderRewardLog();

        cancelSelectionMode();
        showModal(reward.name);
        renderInventory();
        renderBoxes();
    }

    // --- Logs ---
    function renderRewardLog() {
        const grid = document.getElementById('rewardLogGrid');
        grid.innerHTML = '';
        grid.className = 'reward-grid';
        
        const rewardMap = {};
        BOXES.forEach(b => b.rewards.forEach(r => rewardMap[r.name] = r.img));

        for(let [name, count] of Object.entries(rewardCounts)) {
            const div = document.createElement('div');
            div.className = 'reward-item';
            const imgUrl = rewardMap[name] || '';
            div.innerHTML = `
                <img src="${imgUrl}" class="reward-img" alt="${name}">
                <span class="reward-name">${name}</span>
                <span class="reward-count">${count}</span>
            `;
            grid.appendChild(div);
        }
    }

    // --- Helpers ---
    function getZodiacName(id) {
        return ZODIACS.find(z => z.id === id).name;
    }

    function log(msg) {
        const area = document.getElementById('logArea');
        const time = new Date().toLocaleTimeString();
        area.innerHTML = `[${time}] ${msg}<br>` + area.innerHTML;
    }

    function showModal(rewardName) {
        document.getElementById('modalReward').innerText = rewardName;
        document.getElementById('rewardModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('rewardModal').style.display = 'none';
    }

    // Start
    init();

</script>
</body>
</html>